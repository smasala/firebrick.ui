/*!
 * @author Steven Masala [me@smasala.com]
 */

define(["knockout","knockout-mapping","jquery","doT","text!./Table.html","text!./tpls/checkbox.html","../common/Base","datatables","jquery-treetable","responsive-tables-js","./plugins/EditableTable"],function(e,t,n,r,i,s){return e.bindingHandlers.trRenderer||(e.virtualElements.allowedBindings.trRenderer=!0,e.bindingHandlers.trRenderer={init:function(e,t,r,i,s){var o=t(),u=o.propDataName,a=n(e);a.prop(u,i)}}),Firebrick.define("Firebrick.ui.table.Table",{extend:"Firebrick.ui.common.Base",sName:"table.table",tpl:i,responsiveClass:!0,responsive:!0,editType:"row",columns:null,tdSpanClass:"fb-ui-tablecell-data",tableStriped:!0,tableHover:!0,tableCondensed:!1,tableBordered:!1,showHeadings:!0,showRows:!0,editabletable:!1,propDataName:"fb-ui-tr-data",datatable:!1,_datatable:{},expandable:!0,expanded:!1,showCaption:!0,expandText:"Expand",collapseText:"Collapse",showOptions:!0,editModalConfig:null,_itemId:0,treetable:!1,_treetable:function(){var e=this;return{expandable:e.expandable,initialState:e.expanded?"expanded":"collapsed",expanderTemplate:'<a class="glyphicon">&nbsp;</a>'}},_allCheckedObservableProp:null,init:function(){var e=this;e.data=t.fromJS(e.data),e.on("rendered",function(){var t=e.getId(),r=e.getElement();e.datatable&&!e.treetable&&(e._preTableConfig("datatable"),r.dataTable(e.datatable)),e.editabletable&&r.EditableTable(),e.treetable&&(e.showOptions&&(n("a#fb-expand-"+t).on("click",e.generateOnclick("expandAll")),n("a#fb-collapse-"+t).on("click",e.generateOnclick("collapseAll"))),e._preTableConfig("treetable"),r.treetable(e.treetable)),e.responsive&&window.responsiveTables&&window.responsiveTables.update(t)}),e.callParent(arguments)},__preTableConfig:function(e){var t=this,r=t[e];return!n.isPlainObject(r)&&!n.isFunction(r)&&(r={}),n.isFunction(t[e])&&(r=r.apply(t)),t[e]=r,t},_preTableConfig:function(e){var t=this,n="_"+e;return t.__preTableConfig(e),t.__preTableConfig(n),t[e]=Firebrick.utils.copyover(t[e],t[n]),t},containerBindings:function(){var e=this;return{css:{"'responsive'":e.responsiveClass}}},_getData:function(){var e=this;return e.store&&e.store.isStore?"Firebrick.getById('"+e.getId()+"').getData()":{}},bindings:function(){var e=this,t=e.callParent(arguments);return t["with"]=e._getData(),t.css.table=!0,t.css["'table-striped'"]=e.tableStriped,t.css["'table-hover'"]=e.tableHover,t.css["'table-condensed'"]=e.tableCondensed,t.css["'table-bordered'"]=e.tableBordered,t.css["'responsive'"]=e.responsive,t},theadBindings:function(){var e=this,t={"if":!1};return e.columns&&(t["if"]=!0),t},theadTRBindings:function(){return{foreach:"Firebrick.getById('"+this.getId()+"').columns"}},theadTRTDBindings:function(){var e=this;return{htmlWithBinding:"Firebrick.getById('"+e.getId()+"')._thRenderer($data, $context, $parent, $root)"}},_thRenderer:function(e,t,n,r){var i=this,s=e.type,o=e.text?e.text:e;return s==="checkbox"&&(o='<input type="checkbox" data-bind="'+i.dataBind("thCheckboxBindings")+'" /> '+o),o},tbodyBindings:function(){return{}},tbodyTRTemplateBindings:function(){var e=this;return{template:{name:e.parseBind(e._getTplId()),foreach:"$data"}}},tbodyTRBindings:function(){var e=this;return{foreach:"Firebrick.getById('"+e.getId()+"').columns",attr:{"'data-tt-id'":"Firebrick.getById('"+e.getId()+"')._getItemId( $data )","'data-tt-parent-id'":"$parent.id"},css:{group:"$data.children ? true : false"},trRenderer:"Firebrick.getById('"+e.getId()+"')"}},_getItemId:function(e){var t=this;if(n.isPlainObject(e))return e.hasOwnProperty("id")||(e.id=t._itemId++),e.id;return},tbodyTRTDBindings:function(){return{attr:{"'data-tt-id'":"$index","'fb-ui-row-id'":"$parentContext.$parent.id"}}},tbodyTRTDSpanBindings:function(){var e=this,t={css:{},allowBindings:!0,htmlWithBinding:"Firebrick.getById('"+e.getId()+"')._tdRenderer($data, $context, $parentContext, $root, $element)"};return t.css[e.parseBind(e.tdSpanClass)]=!0,t},_tdRenderer:function(e,t,r,i,s){var o=this,u=Firebrick.utils.getDeepProperty(e.mapping,r.$data),a=o.b(u),f=e.type,l="fb-ui-col-"+t.$index();return e._colId||(e._colId=l),n(s).addClass(l),f&&(f==="number"?a=parseInt(a):f==="float"?a=parseFloat(a):f==="checkbox"&&u!==null&&(typeof a=="string"&&(a=a==="true"?!0:!1),a=o.checkboxRenderer(e,u,a,t,r,i,s))),e.renderer&&(a=e.renderer(e,u,a,t,r,i,s)),a},thCheckboxBindings:function(){var e=this,t={};return t.checked="Firebrick.getById('"+e.getId()+"')._allCheckedObservable($context)",t},_allCheckedObservable:function(t){var r=this,i=t.$data,s=r.getElement();return r._allCheckedObservableProp=r._allCheckedObservableProp||e.computed({read:function(){var e=i.mapping,t=r.getData(),s=function(t){var r,i;r=Firebrick.utils.getDeepProperty(e,t);if(n.isFunction(r)&&!r())return!1;if(t.children){i=t.children();for(var o=0,u=i.length;o<u;o++)return s(i[o])}return!0};if(t&&n.isFunction(t)){t=t();for(var o=0,u=t.length;o<u;o++)return s(t[o])}return!1},write:function(e){var t=n("tbody tr",s),o,u=i.mapping;for(var a=0,f=t.length;a<f;a++)o=Firebrick.utils.getDeepProperty(u,n(t[a]).prop(r.propDataName)),n.isFunction(o)&&o(e)}}),r._allCheckedObservableProp},checkboxRenderer:function(e,t,n){var i=this;return r.template(s)({scope:i,value:n})},checkboxBindings:function(e){return{checked:"Firebrick.utils.getDeepProperty( $data.mapping, $parent )"}},_getTplId:function(){return"fb-ui-tpl-"+this.getId()},tbodyTRChildrenTemplateBindings:function(){var e=this;return{template:{name:e.parseBind(e._getTplId()),foreach:"$data.children"}}},captionBindings:function(){var e=this;return{show:e.showCaption}},generateOnclick:function(e){var t=this;return function(){return t.getElement().treetable(e),!1}},expandBindings:function(){var e=this;return{text:e.textBind(e.expandText),attr:{id:e.parseBind("fb-expand-"+e.getId()),href:"''"}}},collapseBindings:function(){var e=this;return{text:e.textBind(e.collapseText),attr:{id:e.parseBind("fb-collapse-"+e.getId()),href:"''"}}}})});