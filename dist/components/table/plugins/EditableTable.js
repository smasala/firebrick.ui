/*!
 * @author Steven Masala [me@smasala.com]
 */

define(["jquery"],function(e){"use strict";var t=Firebrick.define("Firebrick.ui.table.plugins.EditableTable",{indexAttr:"data-tt-id",rowAttr:"fb-ui-row-id",editMarker:"fb-ui-cell-editing",currentEdit:null,hideCellClass:"fb-ui-hide-me",rowLoadClass:"fb-ui-edit-loading",editFields:function(e,t,n){var r=this,i=[],s=[],o={},u=e.is("tr"),a=u?e:e.closest("tr"),f,l,c;if(n)for(var h=0,p=n.length;h<p;h++)f=u?h:e.attr(r.indexAttr),c=n[h],c.editable!==!1&&(l=r.getFieldConfiguration(t,a,e,c,f,s,o),l&&i.push(l));return{deps:s,items:i}},getFieldConfiguration:function(t,n,r,i,s,o,u){var a=this,f=i.editConf&&i.editConf.field?i.editConf.field:{},l,c=n.prop(t.propDataName),h=Firebrick.utils.getDeepProperty(i.mapping,c);if(c.children&&i.editConf&&i.editConf.parentsEditable===!1)return;if(h===null||h===undefined)return;if(i.renderer&&!i.type)return;return f.sName?l=Firebrick.classes.getSNameConfig(f.sName).path:(f.sName=i.type==="checkbox"?"fields.checkbox":"fields.input",l=Firebrick.classes.getSNameConfig(f.sName).path),u[l]||(u[l]=!0,o.push(l)),f.label=f.label||(i.text?i.text:i),f.init=a._initFunction(s),f.value=e.isFunction(h)?h():h,typeof f.value=="string"&&(f.value="'"+f.value+"'"),f},removeCurrent:function(e){var t=this;e.removeClass(t.editMarker),t.currentEdit=null},cancelChanges:function(e,t){var n=this;n.resetCell(e,t)},resetCell:function(t,n,r){var i=this,s=t.tdSpanClass,o=e("> [fb-view-bind]",n);i.removeCurrent(n),o.length&&o.remove(),n.children().removeClass(i.hideCellClass),r&&e("> span."+s,n).html(r)},parseValue:function(e,t){return e==="number"?parseInt(t):e==="float"?parseFloat(t):t},makeChanges:function(t,n){var r=this,i=t.columns,s=t.treetable,o=n.find("input"),u,a,f,l,c=t.tdSpanClass,h=t.editType,p=n.is("tr"),d=p?n:n.closest("tr"),v=p?n.attr(r.indexAttr):n.attr(r.rowAttr),m;t.fireEvent("beforeChanges",arguments);if(o.length)for(var g=0,y=o.length;g<y;g++){u=e(o[g]);if(u.attr("type")==="radio"||u.attr("type")==="checkbox"){if(!u.is(":checked"))continue;m=Firebrick.getById(u.attr("data-cmp-id"))._prop}else m=Firebrick.getById(u.attr("id"))._prop;f=Firebrick.utils.getDeepProperty(i[m].mapping,d.prop(t.propDataName)),l=f();if(f){a=u.val(),a=r.parseValue(i[m].type,a);if(h==="cell"&&a===l)return r.cancelChanges(t,n);f.value?(f.value(a),p||r.resetCell(t,n)):a!==l&&(f(a),p||r.resetCell(t,n,a))}}t.fireEvent("afterChanges",arguments)},buildModal:function(t,n,r){var i=this,s=t.editModalConfig||{},o={title:s.modalTitle||"Edit",target:r,items:[{sName:"containers.form",preSubmit:function(){var n=this;return i.makeChanges(t,r),e(n._parent.getElement()).modal("hide"),!1},items:n.items}]};s._showEditButtons!==!1&&(o.footerItems=[{sName:"button.button",closeModal:!0,text:s.buttonUpdateText||"Update",handler:function(){i.makeChanges(t,r)}}]),s=Firebrick.utils.overwrite(o,s),n.deps.push(Firebrick.classes.getSNameConfig("containers.modal").path),n.deps.push(Firebrick.classes.getSNameConfig("containers.form").path),n.deps.push(Firebrick.classes.getSNameConfig("button.button").path),i.tableLoadMask(t.getElement()),require(n.deps,function(){Firebrick.create("Firebrick.ui.containers.Modal",s),i.removeTableLoadMask(t.getElement())})},tableLoadMask:function(t){var n=this,r=e("tbody",t),i=e("<div class='fb-ui-load-mask'></div>");r.addClass(n.rowLoadClass),n.appendLoadIcon(i),r.append(i)},removeTableLoadMask:function(t){var n=this,r=e("tbody",t);r.removeClass(n.rowLoadClass),e("> div.fb-ui-load-mask",r).remove()},appendLoadIcon:function(e){e.append("<span class='fb-ui-load-block glyphicon glyphicon-refresh glyphicon-refresh-animate'></span>")},removeLoadIcon:function(t){e("> .fb-ui-load-block",t).remove()},buildCellEditor:function(e,t,n){var r=this;t.deps.push(Firebrick.classes.getSNameConfig("containers.box").path),r.appendLoadIcon(n),require(t.deps,function(){var i=t.items[0];n.children().addClass(r.hideCellClass),i.label=!1,i.inputWidth=12,i.inputContainerBindings=r.cellEditInputContainerBindings(),i.init=r._cellEditInit(e,n),Firebrick.create("containers.box",{target:n,appendTarget:!0,enclosedBind:!0,items:[i]}),r.removeLoadIcon(n)})},initEditingTR:function(e,t,n){var r=this,i=r.editFields(n,e,e.columns);i.items.length&&r.buildModal(e,i,n)},initEditingTD:function(t,n,r){var i=this,s=i.currentEdit,o=r.attr(i.indexAttr),u,a;if(i.currentEdit){if(i.currentEdit.is(r))return;i.makeChanges(t,s)}i.currentEdit=r,a=function(n){var r=e(n.target),s=i.currentEdit;s?!s.is(r)&&!s.has(r).length&&(i.makeChanges(t,s),e(document).off("click",a)):e(document).off("click",a)},e(document).on("click",a),r.hasClass(i.editMarker)||(u=i.editFields(r,t,[t.columns[o]]),u.items.length&&(r.addClass(i.editMarker),i.buildCellEditor(t,u,r)))},cellEditInputContainerBindings:function(){return function(){var e=this,t=e.callParent(arguments);return t.css["'col-md-10'"]=!0,t.css["'col-lg-8'"]=!0,t}},_defaultRenderAction:function(e,t){e._prop=t},_initFunction:function(e){var t=this;return function(){var n=this;return n.on("rendered",function(){t._defaultRenderAction(n,e)}),n.callParent(arguments)}},_cellEditInit:function(e,t){var n=this;return function(){var r=this,i=r.sName;return r.on("rendered",function(){var s=r.getElement(),o,u;n._defaultRenderAction(r,t.attr(n.indexAttr)),s.on("keydown",function(r){var i=r.which;i===13?n.makeChanges(e,t):i===27&&n.cancelChanges(e,t)}),i!=="fields.input"?(o=s.is("input")?s:s.find("input"),u=function(){n.makeChanges(e,t),o.off("change",u)},o.on("change",u)):s.focus()}),r.callParent(arguments)}}});return e.fn.EditableTable=e.fn.EditableTable||function(){var t=e(this),n,r=Firebrick.create("Firebrick.ui.table.plugins.EditableTable"),i=Firebrick.getById(t.attr("id")),s=i.editType,o,u,a;t.addClass("fb-ui-editabletable");if(s==="row")t.addClass("fb-ui-row-editing"),t.attr("unselectable","on"),n=e("tbody tr",t),o=function(){var n=e(this);n.is("tr")&&r.initEditingTR(i,t,n)};else if(s==="cell"){if(!i.datatable){u=e("> thead th",t);for(var f=0,l=u.length;f<l;f++)a=e(u[f]),a.css("width",a.width())}n=e("tbody td",t),o=function(){var n=e(this);n.is("td")&&r.initEditingTD(i,t,n)}}n.on("dblclick",o)},t});