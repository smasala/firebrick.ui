/*!
 * @author Steven Masala [me@smasala.com]
 */

define(["text!./ComboBox.html","jquery","text!./combo/Item.html","text!./combo/Group.html","text!./combo/Value.html","doT","./Input","Firebrick.ui.engines/Suggest","../display/Loader"],function(e,t,n,r,i,s){"use strict";return Firebrick.define("Firebrick.ui.fields.ComboBox",{extend:"Firebrick.ui.fields.Input",sName:"fields.combobox",subTpl:e,multiSelect:!1,maxItems:!1,forceSelect:!1,typeahead:1,store:null,itemTpl:n,groupTpl:r,valueTpl:i,_itemTemplate:null,_resultsVisible:!1,labelKey:"text",valueKey:"value",groupLabelKey:null,_valueEl:null,suggest:null,_engine:null,_timestamp:null,getValueEl:function(){var e=this;return e._valueEl||(e._valueEl=t("> .fb-ui-combo-values",e.getElement())),e._valueEl},_inputEl:null,getInputEl:function(){var e=this;return e._inputEl||(e._inputEl=t("> input.fb-ui-combo-input",e.getElement())),e._inputEl},showCaret:!0,_caretEl:null,getCaretEl:function(){var e=this;return e._caretEl||(e._caretEl=t("> .fb-ui-combo-select",e.getElement())),e._caretEl},_resultEl:null,getResultEl:function(){var e=this;return e._resultEl||(e._resultEl=e.getElement().next(".fb-ui-combo-result[data-for='"+e.getId()+"']")),e._resultEl},_clearIconEl:null,getClearIconEl:function(){var e=this;return e._clearIconEl||(e._cleanIconEl=t(".fb-ui-combo-clear-icon",e.getElement())),e._cleanIconEl},focus:function(){this.getInputEl().focus()},init:function(){var e=this;return e._itemTemplate={},e.on("rendered",function(){e._initSuggestionEngine(),e._initRendered()}),e.on("removeAll",function(){e.getClearIconEl().hide()}),e.callParent(arguments)},_initSuggestionEngine:function(){var e=this,t={store:e.store,filter:function(e){return!e._exclude}};t=Firebrick.utils.overwrite(t,e.suggest||{}),e._engine=Firebrick.create("Firebrick.ui.engines.Suggest",t)},_initRendered:function(){var e=this,n=e.getElement(),r=e.getInputEl(),i=e.getResultEl(),s=e.getClearIconEl();n.on({click:function(){return e._onClick.apply(e,arguments)}}),s.on({click:function(){return e._onClearIconClick.apply(e,arguments)}}),r.on("keydown keyup fb.update blur",function(){return e.resizeInput.apply(e,arguments)}),r.on({focus:function(){return e._onFocus.apply(e,arguments)},keydown:function(){return e._onKeyDown.apply(e,arguments)},keyup:function(){return e._onKeyUp.apply(e,arguments)},blur:function(){return e._onBlur.apply(e,arguments)}}),i.on("mousedown",".fb-ui-combo-item",function(){return e._onItemClick.apply(e,arguments)}),i.on("mouseover",".fb-ui-combo-item",function(){return e._onMouseOver.apply(e,arguments)}),e.multiSelect&&n.on("click",".fb-ui-combo-value-item",function(){return e.removeItem(t(this))}),e.on({expand:function(){var e=this,n=e.getElement(),r=e.getResultEl(),i=e.getActiveItem(),s;n.addClass("open"),e.forceSelect&&!i.length&&(s=t(".fb-ui-combo-item:first-child",r),s.length&&e.markActive(s))},collapse:function(){e.resultDefaults()}})},resultDefaults:function(){var e=this,t=e.getElement();t.removeClass("open")},_onFocus:function(){var e=this;e.showResults(),e.getValue().length&&e.getClearIconEl().show()},_onClick:function(){var e=this,t=e.getInputEl();t.focus()},_onClearIconClick:function(){this.removeAll()},_onItemClick:function(){var e=this;e.selectActive()},_onMouseOver:function(e){var n=this,r="fb-ui-combo-item",i="."+r,s=t(e.target);s.hasClass(r)||(s=s.parent(i)),n.markActive(s)},_onKeyDown:function(e){var t=this,n=e.which,r=Firebrick.ui.KeyEvents,i=t.getInputEl();n===r.DOM_VK_RETURN?e.preventDefault():n===r.DOM_VK_BACK_SPACE&&(i.val()||t.removeLastItem()),t._arrowKey(n),t._timestamp=(new Date).getTime()},_onKeyUp:function(e){var t=this,n=e.which,r=Firebrick.ui.KeyEvents,i=t.getInputEl();t.actionKey(n)?n===r.DOM_VK_RETURN?(e.preventDefault(),t.selectActive()):n===r.DOM_VK_DOWN&&(i.val()||t._resultsVisible||t.showResults()):i.val().trim()?Firebrick.delay(function(){var e=(new Date).getTime();e-t._timestamp>=300&&(t._timestamp=e,t.showResults())},301):t.hideResults()},_onBlur:function(){var e=this;e.forceSelect&&(e.getValue().length||e.selectActive()),Firebrick.delay(function(){e.getClearIconEl().hide()},200),e.hideResults()},reset:function(){var e=this;e.hideResults(),e.clearInput()},resizeInput:function(){var e=this,t=e.getInputEl(),n=t.width(),r=e._measureWidth(t)+8;r!==n&&t.width(r)},_measureWidth:function(e){var n=t("<tmp>").css({position:"absolute",top:-99999,left:-99999,width:"auto",padding:0,whiteSpace:"pre"}).text(e.val()).appendTo("body"),r=["letterSpacing","fontSize","fontFamily","fontWeight","textTransform"],i,s={},o;for(var u=0,a=r.length;u<a;u++)i=r[u],s[i]=e.css(i);return n.css(s),o=n.width(),n.remove(),o},actionKey:function(e){var t=Firebrick.ui.KeyEvents;return e===t.DOM_VK_DOWN||e===t.DOM_VK_UP||e===t.DOM_VK_RETURN?!0:!1},getActiveItem:function(){var e=this,n=t(".fb-ui-combo-item.active",e.getResultEl());return n},markActive:function(e){var t=this,n=t.getActiveItem();e.length&&(n.removeClass("active"),e.addClass("active"),e.focus())},selectActive:function(e){var t=this,n=e||t.getActiveItem(),r={},i=[];n.length&&(r=n.prop("data-value"),r._exclude=!0,i.push(r),t.setValue(i),i.length&&t.getClearIconEl().show())},removeAll:function(){var e=this,n=e.getValue(),r=t(".fb-ui-combo-value-item",e.getValueEl());for(var i=0,s=r.length;i<s;i++)t(r[0]).prop("data-value")._exclude=!1;r.remove(),e._checkChange(e.getValue(),n),e.fireEvent("removeAll")},removeItem:function(e){var t=this,n=t.getValue(),r=e.prop("data-value");r._exclude=!1,e.remove(),t._checkChange(t.getValue(),n),t.on("removeItem")},removeLastItem:function(){var e=this,n=t(".fb-ui-combo-value-item",e.getValueEl()),r=n.last();if(n.length===1&&e.forceSelect)return;r.length&&e.removeItem(r)},clearInput:function(){var e=this,t=e.getInputEl();t.val("")},_arrowKey:function(e){var n=this,r=Firebrick.ui.KeyEvents,i=".fb-ui-combo-item",s=".fb-ui-combo-group-item",o=n.getResultEl(),u=t(i+".active",o),a;if(n._resultsVisible)if(e===r.DOM_VK_DOWN||e===r.DOM_VK_UP)return u.length?(e===r.DOM_VK_DOWN?(a=u.next(),a.length||(a=u.closest(s).next())):(a=u.prev(),a.length||(a=u.closest(s).prev())),a.is(s)&&(e===r.DOM_VK_DOWN?a=a.find(i).first():a=a.find(i).last()),n.markActive(a),n._scrollOnKey(e,a,o)):n.markActive(o.find(".fb-ui-combo-item").first()),!0;return!1},getSelection:function(){var e=this,n=e.getResultEl();if(e._resultsVisible)return t(".fb-ui-combo-item.active",n)},_scrollOnKey:function(e,t,n){var r,i,s=Firebrick.ui.KeyEvents,o=n.offset().top,u=n.height(),a=o+u,f=null;t.length&&(e===s.DOM_VK_DOWN?(i=t.offset().top+t.outerHeight(),i>a&&(f=n.scrollTop()+i-o-u)):(r=t.offset().top,r<o&&(f=r-o+n.scrollTop())),f!==null&&n.scrollTop(f))},search:function(e,t){var n=this;return n._engine.query(e,t),n},showResults:function(){var e=this,t=e.getElement(),n=e.getInputEl(),r=e.getResultEl(),i=n.val().trim(),s,o;i.length>=e.typeahead&&(r.empty(),r.css({top:t.offset().top+t.outerHeight(),width:t.outerWidth()}),r.show(),e._resultsVisible=!0,e._engine.mode!=="local"&&(s=Firebrick.create("Firebrick.ui.display.Loader",{target:r})),Firebrick.delay(function(){e.search(i,function(t){var n=[];s&&s.destroy();if(t){for(var i=0,u=t.length;i<u;i++)o=t[i],o.index=i,n.push(e.renderItem(o));r.empty(),r.append(n),r.scrollTop(0),e.fireEvent("expand")}})},10))},hideResults:function(){var e=this,t=e.getResultEl();e._resultsVisible&&(e._resultsVisible=!1,t.hide(),e.fireEvent("collapse"))},renderChildren:function(e,t){var n=this,r=[];if(e.children)for(var i=0,s=e.children.length;i<s;i++)r.push(n.renderItem(e.children[i],t));return r},renderItem:function(e,n){var r=this,i=e.children?"groupTpl":"itemTpl",s;return s=r._renderItem(i,e,n),e.children&&t(".fb-ui-combo-group-children",s).html(r.renderChildren(e,n)),s},renderValueItem:function(e,t){return this._renderItem("valueTpl",e,t)},_renderItem:function(e,n,r){var i=this,o=t.isFunction(i[e])?i[e]():i[e];return n._scope=n._scope||r||i,i._itemTemplate[e]||(i._itemTemplate[e]=s.template(o)),t(i._itemTemplate[e](n)).prop("data-value",n)},bindings:function(){var e=this,t=e.callParent(arguments);return t.css["'fb-ui-combobox'"]=!0,e.multiSelect?t.css.multiple=!0:t.css.single=!0,t},valueBindings:function(){var e={css:{"'fb-ui-combo-values'":!0}};return e},inputBindings:function(){var e={css:{},attr:{autocomplete:!0,tabindex:!0}};return e.css["'fb-ui-combo-input'"]=!0,e},clearIconBindings:function(){var e={css:{glyphicon:!0,"'glyphicon-remove-circle'":!0,"'fb-ui-combo-clear-icon'":!0}};return e},singleSelectBindings:function(){var e=this,t={css:{"'fb-ui-combo-select'":!0,caret:e.typeahead===0?e.showCaret:!1}};return t},resultBindings:function(){var e={css:{"'fb-ui-combo-result'":!0}};return e},_hasChange:function(e,t){return!Firebrick.utils.compareArrays(e,t)},getValue:function(){var e=this,n=t("> .fb-ui-combo-value-item",e.getValueEl()),r=[],i=e.valueKey,s;for(var o=0,u=n.length;o<u;o++)s=t(n[o]).prop("data-value"),s=i?s[i]:s,r.push(s);return r},setValue:function(){var e=this,n=e.getValueEl();if(e.maxItems!==!1&&t(".fb-ui-combo-value-item",n).length===e.maxItems)return;return e.callParent(arguments)},_setValue:function(e){var t=this,n=t.getValueEl(),r=[];if(e.length){for(var i=0,s=e.length;i<s;i++)r.push(t.renderValueItem(e[i]));t.multiSelect?n.append(r):n.html(r),t.reset()}return t}})});