/*!
 * @author Steven Masala [me@smasala.com]
 */

define(["jquery","knockout","Firebrick.ui/containers/GridRow","Firebrick.ui/containers/Box","Firebrick.ui/button/Icon"],function(e,t){"use strict";return Firebrick.define("Firebrick.ui.fields.plugins.InplaceEdit",{fieldItem:null,items:null,showInplaceTitle:!0,title:null,container:"body",width:"250px",placement:"auto bottom",actionButtonsFooter:!1,_getPopoverEl:function(){var e=this;return e.fieldItem.getElement().data("bs.popover").$tip},init:function(){var e=this,t=e.fieldItem.getElement();t?(t.on("click",function(){return e.onEditClick.apply(e,arguments)}),e.fieldItem.on("changed",function(){t.addClass("fb-ui-inplaceedit-changed")})):console.info("no el",e)},buildItems:function(){var e=this,t=[],n=e.fieldItem.type,r,i="Firebrick.getById('"+e.fieldItem.getId()+"').getValue()",s;return e.items?t=e.items:(r={css:"fb-ui-inplaceedit-field",inputSize:"sm",label:!1,inputWidth:12},n==="text"?s={sName:"fields.input",value:i}:n==="select"&&(s={sName:"fields.selectbox",options:e.fieldItem.options},e.fieldItem.multiSelect?s.selectedOptions=i:s.value=i),t.push(Firebrick.utils.overwrite(r,s))),t},showPopover:function(){var e=this;e._initBSPopover(),e._showBSPopover(),e._initPopoverContent()},_initPopoverContent:function(){var n=this;Firebrick.create("Firebrick.ui.containers.GridRow",{target:e(".popover-content",n._getPopoverEl()),store:t.dataFor(n.fieldItem.getElement()[0]),items:[{columnWidth:n.actionButtonsFooter?12:7,items:n.buildItems()},{columnWidth:n.actionButtonsFooter?12:5,items:n.actionButtons()}]})},_initBSPopover:function(){var e=this,t=Firebrick.text(e.showInplaceTitle?e.fieldItem.popoverTitle||e.fieldItem.label||"":"");e.fieldItem.getElement().popover({html:!0,title:t||" ",container:e.container,placement:e.placement,trigger:"manual"})},_showBSPopover:function(){var e=this,t,n=e.fieldItem.getElement();n.popover("toggle"),t=e._getPopoverEl(),e.width&&(t.css("width",e.width),t.css("max-width",e.width)),e._initDismissEvent()},_initDismissEvent:function(){var t=this;Firebrick.delay(function(){var n=function(r){var i=e(r.target);i.closest(".popover").length||(t.fieldItem.getElement().popover("destroy"),e("html").off("click",n))};e("html").on("click",n),t.fieldItem.getElement().on("hide.bs.popover hidden.bs.popover",function(){e("html").off("click",n)})},1)},okAction:function(){var e=this;e.setValue(e.getValue()),e.fieldItem.getElement().popover("toggle")},cancelAction:function(){var e=this;e.fieldItem.getElement().popover("destroy")},actionButtons:function(){var e=this;return[{sName:"containers.box",css:e.actionButtonsFooter?"pull-right":"",items:[{sName:"button.button",glyIcon:"ok",btnStyle:"primary",btnSize:"sm",handler:function(){return e.okAction.apply(e,arguments)}},{sName:"button.button",glyIcon:"remove",btnStyle:"default",btnSize:"sm",handler:function(){return e.cancelAction.apply(e,arguments)}}]}]},onEditClick:function(){var e=this;e.showPopover()},getValue:function(){var t=this,n=t._getPopoverEl(),r=e(".fb-ui-inplaceedit-field",n);return r.val()},setValue:function(e){var t=this;t.fieldItem.setValue(e)}})});